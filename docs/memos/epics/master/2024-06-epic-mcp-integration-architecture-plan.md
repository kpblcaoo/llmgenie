# Архитектурный план: Интеграция MCP, enforcement и FastAPI-слоя в llmgenie

Дата: 2024-06-13
Автор: ai_assistant

---

## 1. Цели эпика
- Внедрить гибкую, масштабируемую и жёстко управляемую систему enforcement-контроля workflow через MCP и always-on правила.
- Обеспечить возможность расширения через плагины, интеграции с CLI, Ollama, внешними LLM/API и таск-менеджерами.
- Снизить зависимость от agent requested/manual rules, повысить надёжность и прозрачность enforcement.
- Использовать FastAPI-слой как универсальный backend-адаптер для MCP, CLI, Ollama, API моделей и плагинов.

---

## 2. Архитектурные компоненты
### 2.1. MCP-сервер (универсальный enforcement hub)
- Один или несколько MCP-серверов, реализующих мультиплексированные тулзы:
  - `enforce_policy(policy, action, context)` — универсальный шлюз для всех enforcement-правил.
  - `workflow_action(action, params)` — универсальный шлюз для логирования, метрик, CI/CD, docs и др.
- MCP-сервер реализуется как отдельный процесс (Python/Node.js/Go), общается с Cursor через stdout/HTTP/SSE.
- Внутри сервера — маршрутизация по policy/action, поддержка десятков/сотен сценариев.

### 2.2. FastAPI-слой (backend-адаптер)
- FastAPI-приложение, выступающее как "шина" между MCP, CLI, Ollama, внешними API, плагинами.
- Возможности:
  - REST API для вызова CLI-команд, интеграции с Ollama, внешними LLM, таск-менеджерами.
  - Webhook-и и event-driven сценарии (например, запуск тестов по событию, обновление статусов задач).
  - Подключение плагинов (Python-модули, REST endpoints, внешние сервисы).
  - Адаптация под требования MCP: FastAPI может быть "сердцем" MCP-сервера (через HTTP/SSE).
- **Преимущества:**
  - Централизация логики, переиспользование кода, удобная интеграция новых сервисов.
  - Лёгкая адаптация под новые требования (например, интеграция с новыми LLM, таск-менеджерами, CI/CD).

### 2.3. Always-on правила (enforcement policies)
- Критичные политики (security, branch, logging, session management) реализуются как alwaysApply.
- Все остальные enforcement-правила — через MCP (универсальные шлюзы).

---

## 3. Этапы внедрения
1. **Создать ветку epic/mcp-integration от develop.**
2. **Разработать FastAPI-слой:**
   - Базовый REST API для CLI, Ollama, внешних моделей, плагинов.
   - Документировать архитектуру, предусмотреть расширяемость.
3. **Реализовать MCP-сервер (enforcement hub):**
   - Мультиплексированные тулзы (`enforce_policy`, `workflow_action`).
   - Внутри — маршрутизация по policy/action, интеграция с FastAPI.
4. **Интегрировать MCP-сервер с FastAPI:**
   - MCP вызывает FastAPI для выполнения CLI, работы с Ollama, внешними API, плагинами.
   - FastAPI возвращает результат MCP/LLM.
5. **Настроить always-on правила для критичных политик.**
6. **Провести пилот (логирование workflow, enforcement branch policy, интеграция с CLI/Ollama).**
7. **Документировать best practices, сценарии, API, параметры вызова.**
8. **Постепенно расширять покрытие (таск-менеджеры, CI/CD, docs, метрики, плагины).**
9. **Ревизия, lessons learned, обновление архитектуры.**

---

## 4. Best practices
- **Мультиплексировать MCP-тулзы:** одна тулза — много сценариев через параметры.
- **Документировать API и параметры вызова:** чтобы LLM не ошибался в синтаксисе.
- **Использовать FastAPI как "шину" для всех интеграций:** CLI, Ollama, внешние LLM, таск-менеджеры, плагины.
- **Минимизировать always-on правила:** только для критичных стандартов.
- **Всё остальное — через MCP/FastAPI.**
- **Писать плагины как Python-модули или REST endpoints, подключать к FastAPI.**
- **Тестировать на Linux/Mac, учитывать баги на Windows/WSL.**

---

## 5. Риски и caveats
- MCP и custom modes развиваются, возможны баги.
- FastAPI-слой — дополнительная точка отказа, требует тестирования и мониторинга.
- Не все MCP-серверы из open-source работают стабильно, требуется ревизия.
- Лимит 40 MCP-тулзов — критично только при неправильной архитектуре (решается мультиплексированием).
- Возможны сложности с интеграцией некоторых CLI/LLM/таск-менеджеров (требуется адаптация).

---

## 6. Рекомендации
- **Внедрять FastAPI-слой как "сердце" интеграций и enforcement.**
- **Строить MCP-серверы вокруг универсальных шлюзов, не плодить тулзы.**
- **Документировать все сценарии, параметры, API.**
- **Постепенно расширять покрытие, фиксировать lessons learned.**
- **Проводить ревизии и обновлять архитектуру по мере развития Cursor/MCP.**

---

## 7. Ссылки и источники
- [Changelog Cursor 1.0](https://www.cursor.com/changelog)
- [Официальная документация MCP](https://docs.cursor.com/context/model-context-protocol)
- [PulseMCP — каталог MCP-серверов](https://www.pulsemcp.com/clients/cursor-ide)
- [Пример интеграции MCP с Jira (Medium)](https://medium.com/@levi_yehuda/cursor-mcp-a-5-minute-quick-start-guide-3c6f214557d5)
- [Форум Cursor: MCP, custom tools, feedback](https://forum.cursor.com/)

---

_План подготовлен для старта эпика по внедрению MCP-интеграций и FastAPI-слоя в llmgenie. Все предложения и сценарии обсуждаемы!_ 